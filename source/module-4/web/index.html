<!DOCTYPE html>
<html lang="ko">
  <!--
    ì‚¬ìš©ì ë“±ë¡ ë° ë¡œê·¸ì¸ì´ í™œì„±í™”ëœ ìƒˆë¡œìš´ ë²„ì „ì˜ TodoList ì›¹ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.
    ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” í• ì¼ì˜ ì™„ë£Œ ìƒíƒœë¥¼ í† ê¸€í•˜ê³  í• ì¼ì„ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  -->
  <head>
    <title>TodoList ì•±</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.135.0.min.js"></script>
    <script src="js/aws-cognito-sdk.min.js"></script>
    <script src="js/amazon-cognito-identity.min.js"></script>
    <style>
      body {
        font-family: 'Arial', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        padding: 30px;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      }
      .auth-section {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
      }
      .todo-form {
        display: flex;
        margin-bottom: 20px;
      }
      .todo-form input {
        flex-grow: 1;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px 0 0 8px;
        font-size: 16px;
        outline: none;
      }
      .todo-form input:focus {
        border-color: #667eea;
      }
      .todo-form button {
        padding: 12px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        font-size: 16px;
      }
      .todo-form button:hover {
        background: #5a6fd8;
      }
      .todo-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      .todo-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      .todo-item.completed {
        opacity: 0.7;
      }
      .todo-item input[type="checkbox"] {
        margin-right: 15px;
        transform: scale(1.2);
      }
      .todo-text {
        flex-grow: 1;
        font-size: 16px;
      }
      .todo-text.completed {
        text-decoration: line-through;
        color: #888;
      }
      .delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
      }
      .delete-btn:hover {
        background: #c0392b;
      }
      .delete-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }
      .btn-auth {
        margin: 5px;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .d-none {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“ ë‚˜ì˜ í• ì¼ ëª©ë¡</h1>
      
      <!-- ì¸ì¦ ì„¹ì…˜ -->
      <div class="auth-section">
        <div id="loggedOutSection">
          <p>í• ì¼ ì™„ë£Œ ë° ì‚­ì œë¥¼ ìœ„í•´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
          <button type="button" id="logInButton" class="btn-auth btn-primary" data-toggle="modal" data-target="#loginModal">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</button>
        </div>
        <div id="loggedInSection" class="d-none">
          <p>ë¡œê·¸ì¸ ìƒíƒœì…ë‹ˆë‹¤.</p>
          <button type="button" id="logOutButton" class="btn-auth btn-danger">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <!-- í• ì¼ ì¶”ê°€ í¼ -->
      <div class="todo-form">
        <input type="text" id="todoInput" placeholder="ìƒˆë¡œìš´ í• ì¼ì„ ì…ë ¥í•˜ì„¸ìš”...">
        <button type="button" id="addBtn">ì¶”ê°€</button>
      </div>

      <!-- í• ì¼ ëª©ë¡ -->
      <div id="todoList"></div>
    </div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ë¡œê·¸ì¸</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="form-group">
                <input type="email" class="form-control" id="email" placeholder="ì´ë©”ì¼" required />
              </div>
              <div class="form-group">
                <input type="password" class="form-control" id="pwd" placeholder="ë¹„ë°€ë²ˆí˜¸" required />
              </div>
              <button type="submit" class="btn btn-primary btn-block">ë¡œê·¸ì¸</button>
            </form>
            <div class="text-center mt-3">
              <a href="register.html" class="btn btn-success">íšŒì›ê°€ì…</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API ì—”ë“œí¬ì¸íŠ¸ ë° Cognito ì„¤ì •
      var todosApiEndpoint = 'REPLACE_ME'; // example: 'https://abcd12345.execute-api.ap-northeast-2.amazonaws.com/prod'
      var cognitoUserPoolId = 'REPLACE_ME';  // example: 'ap-northeast-2_abcd12345'
      var cognitoUserPoolClientId = 'REPLACE_ME'; // example: 'abcd12345abcd12345abcd12345'
      var awsRegion = 'REPLACE_ME'; // example: 'ap-northeast-2'

      // ì „ì—­ ë³€ìˆ˜
      let todos = [];
      let isLoggedIn = false;

      // ì´ˆê¸°í™”
      $(document).ready(function() {
        initializeStorage();
        checkLoginStatus();
        loadTodos();
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        $('#addBtn').click(addTodo);
        $('#todoInput').keypress(function(e) {
          if (e.which == 13) {
            addTodo();
          }
        });
        $('#loginForm').submit(loginUser);
        $('#logOutButton').click(logoutUser);
      });

      function initializeStorage() {
        var identityPoolId = cognitoUserPoolId;
        var userPoolId = cognitoUserPoolId;
        var clientId = cognitoUserPoolClientId;
        var loginPrefix = 'cognito-idp.' + awsRegion + '.amazonaws.com/' + identityPoolId;

        localStorage.setItem('identityPoolId', identityPoolId);
        localStorage.setItem('userPoolId', userPoolId);
        localStorage.setItem('clientId', clientId);
        localStorage.setItem('loginPrefix', loginPrefix);
      }

      function checkLoginStatus() {
        var configString = localStorage.getItem("awsConfig");
        var config = JSON.parse(configString);
        if(config != null) {
          refreshAWSCredentials();
          showLoggedInState();
        } else {
          showLoggedOutState();
        }
      }

      function showLoggedInState() {
        isLoggedIn = true;
        $("#loggedOutSection").addClass("d-none");
        $("#loggedInSection").removeClass("d-none");
        $("#loginModal").modal("hide");
      }

      function showLoggedOutState() {
        isLoggedIn = false;
        $("#loggedOutSection").removeClass("d-none");
        $("#loggedInSection").addClass("d-none");
      }

      function loginUser(event) {
        event.preventDefault();
        
        var email = document.getElementById('email').value;
        var password = document.getElementById('pwd').value;
        
        var poolData = {
          UserPoolId: cognitoUserPoolId,
          ClientId: cognitoUserPoolClientId
        };
        
        var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        var userData = {
          Username: email,
          Pool: userPool
        };
        
        var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
        var authenticationData = {
          Username: email,
          Password: password
        };
        
        var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
        
        cognitoUser.authenticateUser(authenticationDetails, {
          onSuccess: function(result) {
            console.log('ë¡œê·¸ì¸ ì„±ê³µ');
            var accessToken = result.getAccessToken().getJwtToken();
            var idToken = result.getIdToken().getJwtToken();
            var refreshToken = result.getRefreshToken().getToken();
            
            var sessionTokens = {
              IdToken: result.idToken,
              AccessToken: result.accessToken,
              RefreshToken: result.refreshToken
            };
            
            localStorage.setItem('sessionTokens', JSON.stringify(sessionTokens));
            refreshAWSCredentials();
            showLoggedInState();
          },
          onFailure: function(err) {
            console.log('ë¡œê·¸ì¸ ì‹¤íŒ¨:', err);
            alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
          }
        });
      }

      function logoutUser() {
        localStorage.clear();
        showLoggedOutState();
        loadTodos(); // ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      }

      function refreshAWSCredentials() {
        var sessionTokensString = localStorage.getItem('sessionTokens');
        if (!sessionTokensString) return;
        
        var sessionTokens = JSON.parse(sessionTokensString);
        var config = {
          region: awsRegion,
          credentials: new AWS.CognitoIdentityCredentials({
            IdentityPoolId: cognitoUserPoolId
          })
        };
        
        localStorage.setItem('awsConfig', JSON.stringify(config));
      }

      function loadTodos() {
        $.ajax({
          url: todosApiEndpoint + '/todos',
          type: 'GET',
          success: function(response) {
            todos = response.todos || [];
            renderTodos();
          },
          error: function(xhr, status, error) {
            console.error('í• ì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('í• ì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        });
      }

      function addTodo() {
        const todoText = $('#todoInput').val().trim();
        if (todoText === '') {
          alert('í• ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        $.ajax({
          url: todosApiEndpoint + '/todos',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ text: todoText }),
          success: function(response) {
            $('#todoInput').val('');
            loadTodos(); // ìƒˆë¡œê³ ì¹¨
          },
          error: function(xhr, status, error) {
            console.error('í• ì¼ ì¶”ê°€ ì‹¤íŒ¨:', error);
            alert('í• ì¼ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        });
      }

      function toggleTodo(todoId) {
        if (!isLoggedIn) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
          return;
        }

        try {
          var sessionTokensString = localStorage.getItem('sessionTokens');
          var sessionTokens = JSON.parse(sessionTokensString);
          var IdToken = sessionTokens.IdToken;
          var idJwt = IdToken.jwtToken;

          $.ajax({
            url: todosApiEndpoint + '/todos/' + todoId + '/toggle',
            type: 'POST',
            headers: { 'Authorization': idJwt },
            success: function(response) {
              loadTodos(); // ìƒˆë¡œê³ ì¹¨
            },
            error: function(xhr, status, error) {
              console.error('í• ì¼ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
              if (xhr.status == 401) {
                refreshAWSCredentials();
              }
              alert('í• ì¼ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          });
        } catch (err) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
          console.log(err.message);
        }
      }

      function deleteTodo(todoId) {
        if (!isLoggedIn) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
          return;
        }

        if (!confirm('ì •ë§ë¡œ ì´ í• ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        try {
          var sessionTokensString = localStorage.getItem('sessionTokens');
          var sessionTokens = JSON.parse(sessionTokensString);
          var IdToken = sessionTokens.IdToken;
          var idJwt = IdToken.jwtToken;

          $.ajax({
            url: todosApiEndpoint + '/todos/' + todoId,
            type: 'DELETE',
            headers: { 'Authorization': idJwt },
            success: function(response) {
              loadTodos(); // ìƒˆë¡œê³ ì¹¨
            },
            error: function(xhr, status, error) {
              console.error('í• ì¼ ì‚­ì œ ì‹¤íŒ¨:', error);
              if (xhr.status == 401) {
                refreshAWSCredentials();
              }
              alert('í• ì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          });
        } catch (err) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
          console.log(err.message);
        }
      }

      function renderTodos() {
        const todoList = $('#todoList');
        todoList.empty();

        if (todos.length === 0) {
          todoList.html('<div class="todo-item"><span class="todo-text">í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í• ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</span></div>');
          return;
        }

        todos.forEach(todo => {
          const todoItem = $(`
            <div class="todo-item ${todo.completed ? 'completed' : ''}">
              <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                     ${isLoggedIn ? '' : 'disabled'} 
                     onchange="toggleTodo(${todo.id})">
              <span class="todo-text ${todo.completed ? 'completed' : ''}">${todo.text}</span>
              <button class="delete-btn" 
                      ${isLoggedIn ? '' : 'disabled'} 
                      onclick="deleteTodo(${todo.id})">ì‚­ì œ</button>
            </div>
          `);
          todoList.append(todoItem);
        });
      }
    </script>
  </body>
</html>
